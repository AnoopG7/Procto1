<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Proctoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    video, canvas {
      max-width: 100%;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
  <div id="preview-section" class="bg-white shadow p-8 rounded w-full max-w-xl">
    <h1 class="text-2xl mb-4 font-bold text-center">Exam Proctoring Preview</h1>
    <p class="mb-4 text-gray-700">
      Please grant access to your <b>webcam</b> and <b>screen</b>. You'll see a preview before the exam starts.
    </p>
    <div class="flex flex-col gap-4">
      <div>
        <h2 class="font-semibold mb-2">Webcam Preview:</h2>
        <video id="webcam-preview" autoplay muted playsinline class="border rounded w-full bg-black"></video>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Screen Preview:</h2>
        <video id="screen-preview" autoplay muted playsinline class="border rounded w-full bg-black"></video>
      </div>
    </div>
    <button id="start-exam-btn" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded font-semibold w-full">Start Exam</button>
    <div id="permission-error" class="mt-4 text-red-600 hidden"></div>
  </div>

  <form id="exam-section" class="hidden bg-white shadow p-8 rounded w-full max-w-xl flex flex-col gap-6">
    <h2 class="text-xl font-bold mb-2 text-center">Exam</h2>
    <div class="text-center text-gray-600 mb-2">Time Left: <span id="countdown">05:00</span></div>
    <div class="flex flex-col gap-4">
      <div>
        <label class="font-medium">1. Describe your approach to problem-solving:</label>
        <textarea name="q1" required class="mt-2 w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="font-medium">2. What motivates you during exams?</label>
        <textarea name="q2" required class="mt-2 w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="font-medium">3. How do you manage stress?</label>
        <textarea name="q3" required class="mt-2 w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="font-medium">4. Give an example of a challenge you overcame:</label>
        <textarea name="q4" required class="mt-2 w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="font-medium">5. Which of the following is a programming language?</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q5" value="Python" required> Python</label><br>
          <label><input type="radio" name="q5" value="Elephant"> Elephant</label><br>
          <label><input type="radio" name="q5" value="Banana"> Banana</label><br>
          <label><input type="radio" name="q5" value="Car"> Car</label>
        </div>
      </div>
      <div>
        <label class="font-medium">6. HTML stands for:</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q6" value="HyperText Markup Language" required> HyperText Markup Language</label><br>
          <label><input type="radio" name="q6" value="HighText Machine Language"> HighText Machine Language</label><br>
          <label><input type="radio" name="q6" value="HyperText Markdown Language"> HyperText Markdown Language</label><br>
          <label><input type="radio" name="q6" value="None of these"> None of these</label>
        </div>
      </div>
      <div>
        <label class="font-medium">7. CSS is used for:</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q7" value="Styling web pages" required> Styling web pages</label><br>
          <label><input type="radio" name="q7" value="Database management"> Database management</label><br>
          <label><input type="radio" name="q7" value="Networking"> Networking</label><br>
          <label><input type="radio" name="q7" value="Operating systems"> Operating systems</label>
        </div>
      </div>
      <div>
        <label class="font-medium">8. JavaScript can be used to:</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q8" value="Make web pages interactive" required> Make web pages interactive</label><br>
          <label><input type="radio" name="q8" value="Wash dishes"> Wash dishes</label><br>
          <label><input type="radio" name="q8" value="Cook food"> Cook food</label><br>
          <label><input type="radio" name="q8" value="None of these"> None of these</label>
        </div>
      </div>
      <div>
        <label class="font-medium">9. Which tag is used to display images in HTML?</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q9" value="img" required> &lt;img&gt;</label><br>
          <label><input type="radio" name="q9" value="image"> &lt;image&gt;</label><br>
          <label><input type="radio" name="q9" value="src"> &lt;src&gt;</label><br>
          <label><input type="radio" name="q9" value="pic"> &lt;pic&gt;</label>
        </div>
      </div>
      <div>
        <label class="font-medium">10. Which one is a front-end framework?</label>
        <div class="mt-2 space-y-1">
          <label><input type="radio" name="q10" value="React" required> React</label><br>
          <label><input type="radio" name="q10" value="Node.js"> Node.js</label><br>
          <label><input type="radio" name="q10" value="MongoDB"> MongoDB</label><br>
          <label><input type="radio" name="q10" value="Express"> Express</label>
        </div>
      </div>
    </div>
    <button type="submit" id="submit-exam-btn" class="mt-6 px-4 py-2 bg-green-600 text-white rounded font-semibold w-full">Submit</button>
  </form>

  <div id="results-section" class="hidden bg-white shadow p-8 rounded w-full max-w-xl">
    <h2 class="text-xl font-bold mb-4 text-center">Exam Proctoring Results</h2>
    <div>
      <h3 class="font-semibold mb-2">Tab/Window Switch Recordings:</h3>
      <div id="switch-recordings" class="space-y-4"></div>
    </div>
    <div class="mt-6">
      <h3 class="font-semibold mb-2">Your Answers:</h3>
      <div id="answers-list"></div>
    </div>
  </div>

  <script>
    // --- Variables ---
    let webcamStream, screenStream;
    let webcamRecorder, screenRecorder;
    let webcamChunks = [];
    let screenChunks = [];
    let switchClips = []; // {webcamBlob, screenBlob, start, end, type}
    let isRecordingSwitch = false;
    let examStarted = false;
    let countdownInterval;
    let timeLeft = 300; // seconds (5 min)

    // --- Elements ---
    const previewSection = document.getElementById('preview-section');
    const webcamPreview = document.getElementById('webcam-preview');
    const screenPreview = document.getElementById('screen-preview');
    const startExamBtn = document.getElementById('start-exam-btn');
    const permissionError = document.getElementById('permission-error');
    const examSection = document.getElementById('exam-section');
    const countdown = document.getElementById('countdown');
    const submitExamBtn = document.getElementById('submit-exam-btn');
    const resultsSection = document.getElementById('results-section');
    const switchRecordings = document.getElementById('switch-recordings');
    const answersList = document.getElementById('answers-list');

    // --- Permissions & Preview ---
    async function getWebcam() {
      try {
        webcamStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 320, height: 240, frameRate: { ideal: 10, max: 15 } },
          audio: false
        });
        webcamPreview.srcObject = webcamStream;
      } catch (err) {
        throw new Error('Webcam permission denied.');
      }
    }

    async function getScreen() {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { width: 640, height: 360, frameRate: { ideal: 10, max: 15 } },
          audio: false
        });
        screenPreview.srcObject = screenStream;
      } catch (err) {
        throw new Error('Screen permission denied.');
      }
    }

    async function showPreview() {
      permissionError.classList.add('hidden');
      try {
        await getWebcam();
        await getScreen();
      } catch (err) {
        permissionError.textContent = err.message;
        permissionError.classList.remove('hidden');
      }
    }
    showPreview();

    // --- Start Exam ---
    startExamBtn.onclick = async () => {
      if (!webcamStream || !screenStream) {
        permissionError.textContent = "Please allow webcam and screen permissions.";
        permissionError.classList.remove('hidden');
        return;
      }
      previewSection.classList.add('hidden');
      examSection.classList.remove('hidden');
      examStarted = true;
      startCountdown();
      setupVisibilityMonitor();
      // No continuous recording; record only "switch" events.
    };

    // --- Tab/Window Switch Monitoring ---
    let lastSwitchType = null; // "tab", "window"
    function setupVisibilityMonitor() {
      // Tab switch (visibilitychange)
      document.addEventListener("visibilitychange", () => {
        if (!examStarted) return;
        if (document.hidden) {
          lastSwitchType = "tab";
          startSwitchRecording("tab");
        } else {
          stopSwitchRecording();
        }
      });

      // Window/application switch (blur/focus)
      window.addEventListener("blur", () => {
        if (!examStarted) return;
        // If already recording via tab switch, don't double-start
        if(!isRecordingSwitch) {
          lastSwitchType = "window";
          startSwitchRecording("window");
        }
      });
      window.addEventListener("focus", () => {
        if (!examStarted) return;
        stopSwitchRecording();
      });
    }

    function startSwitchRecording(type) {
      if (isRecordingSwitch) return;
      isRecordingSwitch = true;
      webcamChunks = [];
      screenChunks = [];
      webcamRecorder = new MediaRecorder(webcamStream, { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 100*1000 });
      screenRecorder = new MediaRecorder(screenStream, { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 200*1000 });
      const switchStartTime = Date.now();

      webcamRecorder.ondataavailable = e => { if (e.data.size > 0) webcamChunks.push(e.data); };
      screenRecorder.ondataavailable = e => { if (e.data.size > 0) screenChunks.push(e.data); };

      webcamRecorder.onstop = () => {
        const webcamBlob = new Blob(webcamChunks, { type: 'video/webm' });
        const screenBlob = new Blob(screenChunks, { type: 'video/webm' });
        switchClips.push({
          webcamBlob,
          screenBlob,
          start: switchStartTime,
          end: Date.now(),
          type: type || lastSwitchType || "unknown"
        });
      };

      webcamRecorder.start();
      screenRecorder.start();
    }

    function stopSwitchRecording() {
      if (!isRecordingSwitch) return;
      isRecordingSwitch = false;
      if (webcamRecorder && webcamRecorder.state !== "inactive") webcamRecorder.stop();
      if (screenRecorder && screenRecorder.state !== "inactive") screenRecorder.stop();
    }

    // --- Countdown ---
    function startCountdown() {
      updateCountdownDisplay();
      countdownInterval = setInterval(() => {
        timeLeft--;
        updateCountdownDisplay();
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          submitExam();
        }
      }, 1000);
    }
    function updateCountdownDisplay() {
      const min = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const sec = String(timeLeft % 60).padStart(2, '0');
      countdown.textContent = `${min}:${sec}`;
    }

    // --- Submission ---
    examSection.onsubmit = function(e) {
      e.preventDefault();
      clearInterval(countdownInterval);
      submitExam();
    };

    function submitExam() {
      examStarted = false;
      stopSwitchRecording(); // In case in middle of a switch
      // Stop webcam & screen streams
      if (webcamStream) webcamStream.getTracks().forEach(t => t.stop());
      if (screenStream) screenStream.getTracks().forEach(t => t.stop());
      examSection.classList.add('hidden');
      showResults();
    }

    // --- Results Page ---
    function showResults() {
      resultsSection.classList.remove('hidden');
      // Show clips
      switchRecordings.innerHTML = '';
      if (switchClips.length === 0) {
        switchRecordings.innerHTML = "<div class='text-gray-500'>No tab/window switch events detected. Good job staying focused!</div>";
      } else {
        switchClips.forEach((clip, i) => {
          const webcamUrl = URL.createObjectURL(clip.webcamBlob);
          const screenUrl = URL.createObjectURL(clip.screenBlob);
          const duration = Math.round((clip.end - clip.start) / 1000);
          const timeString = new Date(clip.start).toLocaleTimeString();
          const div = document.createElement('div');
          div.innerHTML = `
            <div class="font-medium mb-1">Switch #${i+1} <span class="text-gray-500 text-xs">(${clip.type === "tab" ? "Tab Switch" : "Window Switch"}, ${timeString}, ${duration}s)</span></div>
            <div class="flex gap-4">
              <div>
                <div class="text-sm font-bold mb-1">Face:</div>
                <video src="${webcamUrl}" controls class="border rounded w-40 h-28 bg-black"></video>
              </div>
              <div>
                <div class="text-sm font-bold mb-1">Screen:</div>
                <video src="${screenUrl}" controls class="border rounded w-40 h-28 bg-black"></video>
              </div>
            </div>
          `;
          switchRecordings.appendChild(div);
        });
      }

      // Show answers
      answersList.innerHTML = '';
      const formData = new FormData(examSection);
      for (let pair of formData.entries()) {
        const [name, value] = pair;
        const qDiv = examSection.querySelector(`[name="${name}"]`).closest('div');
        const label = qDiv.querySelector('label').textContent;
        answersList.innerHTML += `
          <div class="mb-2">
            <span class="font-semibold">${label}</span><br>
            <span class="text-gray-700">${value}</span>
          </div>
        `;
      }
    }
  </script>
</body>
</html>